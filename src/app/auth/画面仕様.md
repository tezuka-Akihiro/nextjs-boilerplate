# 認証画面 - 画面仕様

## 概要
認証画面の詳細UI定義、バリデーション、状態遷移、エラーハンドリングを定義します。

## ログイン画面仕様

### フォーム項目定義
| 項目名 | 入力タイプ | 必須 | バリデーション | プレースホルダー |
|--------|------------|------|----------------|------------------|
| メールアドレス | email | ✅ | メール形式 + 最大254文字 | "メールアドレスを入力" |
| パスワード | password | ✅ | 最小8文字 | "パスワードを入力" |
| ログイン状態を保持 | checkbox | ❌ | - | - |

### バリデーションルール

#### メールアドレス
```typescript
const emailValidation = {
  required: "メールアドレスを入力してください",
  pattern: /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,
  patternMessage: "有効なメールアドレスを入力してください",
  maxLength: 254,
  maxLengthMessage: "メールアドレスは254文字以内で入力してください"
}
```

#### パスワード
```typescript
const passwordValidation = {
  required: "パスワードを入力してください", 
  minLength: 8,
  minLengthMessage: "パスワードは8文字以上で入力してください"
}
```

### ソーシャルログイン

#### 対応プロバイダー
```typescript
type SocialProvider = 'google' | 'apple'

interface SocialLoginButton {
  provider: SocialProvider
  text: string
  icon: ReactNode
  onClick: () => Promise<void>
}
```

| プロバイダー | 表示テキスト | アイコン | 背景色 |
|-------------|-------------|----------|--------|
| Google | "Googleでログイン" | GoogleIcon | white |
| Apple | "Appleでログイン" | AppleIcon | black |

## 新規登録画面仕様

### フォーム項目定義
| 項目名 | 入力タイプ | 必須 | バリデーション | プレースホルダー |
|--------|------------|------|----------------|------------------|
| メールアドレス | email | ✅ | メール形式 + 重複チェック | "メールアドレスを入力" |
| パスワード | password | ✅ | 複雑性要件 | "パスワードを入力（8文字以上）" |
| パスワード確認 | password | ✅ | 一致確認 | "パスワードを再入力" |
| ユーザー名 | text | ✅ | 文字種・長さ・重複 | "ユーザー名を入力（3-20文字）" |
| 利用規約同意 | checkbox | ✅ | チェック必須 | - |

### 詳細バリデーションルール

#### パスワード複雑性
```typescript
const passwordComplexity = {
  minLength: 8,
  maxLength: 128,
  requireUppercase: false, // 現在は不要
  requireNumber: false,    // 現在は不要
  requireSymbol: false,    // 現在は不要
  message: "パスワードは8文字以上128文字以内で入力してください"
}
```

#### ユーザー名
```typescript  
const usernameValidation = {
  required: "ユーザー名を入力してください",
  minLength: 3,
  maxLength: 20,
  pattern: /^[a-zA-Z0-9_-]+$/,
  patternMessage: "英数字、アンダースコア、ハイフンのみ使用可能です",
  uniqueCheck: true,
  uniqueMessage: "このユーザー名は既に使用されています"
}
```

## 状態管理

### フォーム状態
```typescript
interface AuthFormState {
  // フォームデータ
  email: string
  password: string
  confirmPassword?: string // 登録時のみ
  username?: string        // 登録時のみ  
  rememberMe?: boolean     // ログイン時のみ
  agreeToTerms?: boolean   // 登録時のみ
  
  // UI状態
  isSubmitting: boolean
  errors: Record<string, string>
  socialLoading: SocialProvider | null
}
```

### 送信処理
```typescript
const handleSubmit = async (formData: AuthFormData) => {
  try {
    setIsSubmitting(true)
    
    if (isLoginMode) {
      await authApi.login(formData.email, formData.password)
      router.push('/dashboard')
    } else {
      await authApi.register(formData)
      router.push('/onboarding')
    }
  } catch (error) {
    setErrors(parseAuthError(error))
  } finally {
    setIsSubmitting(false)
  }
}
```

## エラーハンドリング

### エラータイプ別処理
```typescript
type AuthError = {
  code: 'INVALID_CREDENTIALS' | 'EMAIL_TAKEN' | 'USERNAME_TAKEN' | 
        'WEAK_PASSWORD' | 'NETWORK_ERROR' | 'RATE_LIMITED'
  message: string
  field?: string
}
```

### エラーメッセージ表示
| エラーコード | 表示メッセージ | 表示位置 |
|-------------|----------------|----------|
| INVALID_CREDENTIALS | "メールアドレスまたはパスワードが正しくありません" | フォーム上部 |
| EMAIL_TAKEN | "このメールアドレスは既に使用されています" | メールフィールド下 |
| USERNAME_TAKEN | "このユーザー名は既に使用されています" | ユーザー名フィールド下 |
| WEAK_PASSWORD | "より強いパスワードを設定してください" | パスワードフィールド下 |
| NETWORK_ERROR | "接続エラーが発生しました。再度お試しください" | フォーム上部 |
| RATE_LIMITED | "試行回数が上限に達しました。しばらく後に再度お試しください" | フォーム上部 |

### リアルタイムバリデーション
```typescript
const useFieldValidation = (fieldName: string, value: string) => {
  const [error, setError] = useState<string>('')
  
  useEffect(() => {
    const validateField = async () => {
      if (fieldName === 'email' && value) {
        const emailExists = await checkEmailExists(value)
        setError(emailExists ? 'このメールアドレスは既に使用されています' : '')
      }
      
      if (fieldName === 'username' && value) {
        const usernameExists = await checkUsernameExists(value) 
        setError(usernameExists ? 'このユーザー名は既に使用されています' : '')
      }
    }
    
    const debounceTimer = setTimeout(validateField, 500)
    return () => clearTimeout(debounceTimer)
  }, [fieldName, value])
  
  return error
}
```

## パスワードリセット

### フォーム仕様
| 項目名 | 入力タイプ | 必須 | バリデーション |
|--------|------------|------|----------------|
| メールアドレス | email | ✅ | メール形式 + 存在確認 |

### フロー状態
```typescript
type ResetPasswordState = 'input' | 'sending' | 'sent' | 'error'

const ResetPasswordFlow = {
  input: {
    title: "パスワードリセット",
    description: "登録済みのメールアドレスを入力してください",
    buttonText: "リセット用メールを送信"
  },
  sending: {
    title: "送信中...",
    description: "リセット用のメールを送信しています",
    buttonText: "送信中..."
  },
  sent: {
    title: "メールを送信しました", 
    description: "パスワードリセット用のリンクをメールで送信しました",
    buttonText: "ログイン画面に戻る"
  },
  error: {
    title: "送信に失敗しました",
    description: "メールアドレスを確認して再度お試しください", 
    buttonText: "再送信"
  }
}
```

## アクセシビリティ

### キーボード操作
- **Tab移動**: フィールド → ボタン → リンクの順序
- **Enter送信**: フォームフィールドでEnter押下時に送信
- **Escape**: エラーダイアログ・モーダル閉じる

### スクリーンリーダー対応
```tsx
<form aria-labelledby="login-heading" noValidate>
  <h1 id="login-heading">ログインして始める</h1>
  
  <div>
    <label htmlFor="email">メールアドレス</label>
    <input
      id="email" 
      type="email"
      aria-describedby="email-error"
      aria-invalid={!!errors.email}
    />
    {errors.email && (
      <div id="email-error" role="alert" aria-live="polite">
        {errors.email}
      </div>
    )}
  </div>
</form>
```

## パフォーマンス

### 最適化項目
- フォームバリデーション: デバウンス処理（500ms）
- ソーシャルログイン: プリロード（300ms以内）
- エラー表示: アニメーション最小化

### ローディング状態
- **送信中**: ボタン無効化 + スピナー表示
- **バリデーション中**: フィールド右側にスピナー
- **ソーシャル認証**: 該当ボタンのみローディング表示