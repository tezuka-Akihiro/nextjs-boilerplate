# tsumiage サービス統合UI仕様書

## 📋 概要

tsumiageプロジェクトにおけるサービス統合で共通利用されるUI仕様を定義します。各サービス（積み上げ・SNS）の統合ダッシュボード設計で統一して適用する共通ルール・パターンを記述します。

### 適用範囲
- サービス統合ダッシュボード・レイアウト
- セクション間連携・データ同期
- 技術実装パターン・状態管理
- アニメーション・フィードバック

---

## 1. サービス統合ダッシュボード基本構成

### 1サービス1SPA統合レイアウト
```
┌─────────────────────────────────────┐
│           [アプリ名] ヘッダー       │  ← 固定ヘッダー
│    🏠 [サービス1] | 📱 [サービス2]  │
├─────────────────────────────────────┤
│                                     │
│ ┌─────────────────────────────────┐ │  ← セクション1（最重要）
│ │  [セクション1名]                │ │
│ │  [アイコン] [主要データ・状態]   │ │
│ │  [補足情報]                     │ │
│ │  [操作ボタン]                   │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │  ← セクション2（高優先）
│ │  [セクション2名]                │ │
│ │  [アイコン] [主要データ・状態]   │ │
│ │  [補足情報]                     │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │  ← セクション3（中優先）
│ │  [セクション3名]                │ │
│ │  [アイコン] [主要データ・状態]   │ │
│ │  [操作ボタン]                   │ │
│ │  [進捗・状況表示]               │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │  ← セクション4（低優先）
│ │  [セクション4名]                │ │
│ │  [アイコン] [リスト・活動]       │ │
│ │  • [項目1]                      │ │
│ │  • [項目2]                      │ │
│ │  • [項目3]                      │ │
│ └─────────────────────────────────┘ │
│                                     │
└─────────────────────────────────────┘
```

### レイアウト原則
```
基本方針: 縦積み統合レイアウト（1サービス1SPA）
- **固定ヘッダー**: サービス切り替えナビゲーション
- **セクション縦積み**: 優先度順に上から配置
- **一元スクロール**: 画面遷移なし・URL変更なし
- **レスポンシブ統一**: 全デバイスで同一構成
```

### セクション配置ルール
```
優先度別配置:
1. **最重要セクション**: 画面上部・常時表示・主要機能
2. **高優先セクション**: 使用頻度高・重要情報表示
3. **中優先セクション**: 定期利用・進捗確認系
4. **低優先セクション**: 補助機能・履歴・設定系

表示制御:
- **常時表示**: 最重要～中優先（3セクションまで）
- **折り畳み可**: 低優先セクション（必要時展開）
- **遅延読み込み**: 画面外セクションの最適化
```

---

## 2. セクション間連携・データ同期

### セクション間連携パターン
```
[主要操作・ボタン押下]
    ↓ リアルタイム更新
┌─ [メインセクション] ──────────┐
│ [データ項目]: [前値] → [新値]  │ ← 即座更新
│ [進捗項目]: [前値] → [新値]    │ ← アニメーション
└───────────────────────────────┘
    ↓ 連鎖更新（200ms遅延）
┌─ [関連セクション] ────────────┐  
│ [連動項目]: [前値] → [新値]    │ ← 関連反映
└───────────────────────────────┘
    ↓ 外部連携（500ms遅延）
┌─ [通知・ストリーム] ──────────┐
│ 新規追加: [ユーザーの活動]     │ ← 活動表示
└───────────────────────────────┘
```

### データ同期フロー
```
操作実行 → 即座UI反映 → API送信 → 成功時確定 / 失敗時ロールバック
     ↓
他セクション連動更新（優先度順・段階的実行）
     ↓
外部サービス通知（非同期・エラー許容）
```

### 連携タイミング制御
```
同期レベル:
- **即座同期**: 同一データの表示更新（0ms）
- **高速同期**: 直接関連データ（200ms）
- **通常同期**: 統計・集計データ（500ms）
- **遅延同期**: ログ・履歴データ（1000ms）

エラーハンドリング:
- **必須連携**: 失敗時は操作全体をロールバック
- **推奨連携**: 失敗時は警告表示・手動再試行
- **オプション連携**: 失敗時はサイレント・背景で再試行
```

---

## 3. 状態管理・データ共有

### サービス統合状態構造
```typescript
interface ServiceIntegrationState {
  // サービス共通
  global: {
    user: UserState
    notifications: NotificationState
    navigation: NavigationState
  }
  
  // サービス固有
  [serviceName]: {
    sections: {
      [sectionName]: SectionState
    }
    ui: {
      activeSection: string
      loading: boolean
      error: string | null
    }
    data: {
      [dataKey]: any
    }
  }
}
```

### データ共有パターン
```
共有データ階層:
1. **グローバル共有**: 全サービス・全セクションで参照
   - ユーザー情報・認証状態・通知
2. **サービス内共有**: 同一サービス内セクション間で共有
   - サービス固有データ・UI状態
3. **セクション専有**: 個別セクション内でのみ利用
   - セクション固有状態・一時データ

データ更新伝播:
- **グローバル更新**: 全サービスに即座反映
- **サービス内更新**: 関連セクションに段階的反映
- **セクション更新**: 他セクション必要時のみ通知
```

### キャッシュ戦略
```
キャッシュレベル:
- **メモリキャッシュ**: 現在表示データ（セッション中保持）
- **ローカルストレージ**: ユーザー設定・一時保存（永続）
- **セッションストレージ**: ナビゲーション状態（セッション中）
- **IndexedDB**: 大容量データ・オフライン対応（選択的）

更新戦略:
- **即座無効化**: 操作完了時のキャッシュ破棄
- **段階無効化**: 関連データの順次無効化
- **時間無効化**: 一定期間後の自動無効化
- **手動無効化**: ユーザー操作によるリフレッシュ
```

---

## 4. 技術実装パターン

### コンポーネント構成パターン
```
[サービス名]DashboardPage/
├─ DashboardHeader.tsx          ← サービス内ナビゲーション
├─ [セクション1名]Section.tsx   ← 各セクションコンポーネント
├─ [セクション2名]Section.tsx  
├─ [セクション3名]Section.tsx
├─ [セクション4名]Section.tsx
├─ ServiceIntegrationProvider.tsx ← サービス統合状態管理
└─ shared/
   ├─ SectionCard.tsx           ← セクション共通UI
   ├─ LoadingState.tsx          ← 共通ローディング
   ├─ ErrorBoundary.tsx         ← エラーハンドリング
   └─ DataSyncManager.tsx       ← セクション間データ同期
```

### 状態管理技術選択
```
技術スタック:
- **Redux Toolkit**: 全体の統合状態管理・デバッグ支援
- **RTK Query**: APIデータ取得・キャッシュ・同期
- **Zustand**: 軽量セクション状態（必要時のみ）
- **React Query**: リアルタイムデータ・WebSocket連携

パフォーマンス最適化:
- **React.memo**: セクション間の不要再描画防止
- **useMemo/useCallback**: 計算コスト削減
- **React.lazy**: セクション遅延読み込み
- **Virtual Scrolling**: 大容量リスト最適化
```

### WebSocket連携
```
リアルタイム通信:
- **接続管理**: サービス単位での接続・切断
- **チャンネル分割**: セクション別・データ種別での配信
- **再接続制御**: 自動再接続・指数バックオフ
- **オフライン対応**: キューイング・復帰時同期

イベントハンドリング:
- **データ更新**: 該当セクションの即座反映
- **通知配信**: グローバル通知システム連携
- **状態同期**: 他ユーザーとの状態共有
- **エラー処理**: 接続エラー・タイムアウト対応
```

---

## 5. アニメーション・フィードバック

### セクション間連動アニメーション
```javascript
// セクション間データ更新アニメーション
const sectionDataSync = {
  // 主要セクションの即座更新
  primary: {
    duration: 300,
    ease: "easeOut",
    stagger: 0
  },
  // 関連セクションの段階的更新
  secondary: {
    duration: 400,
    ease: "easeInOut", 
    stagger: 200
  },
  // 補助セクションの遅延更新
  tertiary: {
    duration: 500,
    ease: "easeIn",
    stagger: 500
  }
}
```

### フィードバックシステム
```
視覚的フィードバック:
- **データ更新**: 更新セクションのパルス・グロー効果
- **連携反映**: 関連セクションの順次ハイライト
- **成功操作**: 緑色フラッシュ・チェックマーク表示
- **エラー発生**: 赤色フラッシュ・エラーアイコン表示

進捗インジケーター:
- **操作進行中**: 操作セクションのローディング表示
- **連携処理中**: 関連セクションのスケルトン表示
- **完了状態**: 全セクションの成功ステータス表示
- **一部失敗**: 失敗セクションのエラー表示・再試行
```

### パフォーマンス配慮
```
アニメーション最適化:
- **GPU加速**: transform・opacityプロパティ優先
- **フレーム制御**: requestAnimationFrame活用
- **リソース管理**: 不要アニメーションの適切なクリーンアップ
- **デバイス配慮**: 低性能デバイスでの軽量化

バッチ処理:
- **更新統合**: 短時間内の複数更新をバッチ化
- **描画最適化**: レイアウト計算の最小化
- **メモリ管理**: 大量データ更新時のメモリ効率
```

---

## 6. レスポンシブ・デバイス対応

### デバイス別最適化
```
統一レイアウト方針:
📱 Mobile (375px以下):
- **フル幅表示**: セクション間マージン最小化
- **縦積み維持**: 同一構成・順序保持
- **タッチ最適化**: ボタンサイズ・間隔調整

💻 Desktop (1200px以上):
- **中央固定幅**: 480px幅・中央配置
- **余白利用**: サイドエリアの効果的活用
- **ホバー対応**: マウスインタラクション強化

🖥️ Large Desktop (1600px以上):
- **サイドパネル**: 補助情報・ショートカット表示
- **並列表示**: 重要セクションの2カラム配置検討
```

### 表示優先度制御
```
デバイス別表示制御:
Mobile:
- **必須表示**: 最重要セクションのみ常時表示
- **折り畳み**: 中・低優先セクションは折り畳み状態
- **スワイプ**: セクション間の水平スワイプナビゲーション

Desktop:
- **全表示**: 全セクション展開状態で表示
- **固定配置**: セクション位置の固定・スクロール追従
- **キーボード**: ショートカットキーでセクション間移動
```

---

## 7. パフォーマンス・最適化

### 表示最適化戦略
```
遅延読み込み:
- **画面外セクション**: Intersection Observer活用
- **重いコンポーネント**: React.lazy + Suspense
- **画像・メディア**: 必要時のみ読み込み
- **データ取得**: 表示直前のAPIコール

メモリ管理:
- **不要データ削除**: 非表示セクションのデータクリア
- **キャッシュサイズ制限**: LRU方式でのキャッシュ管理
- **メモリリーク防止**: イベントリスナー・タイマーのクリーンアップ
```

### ネットワーク最適化
```
API効率化:
- **バッチ取得**: 複数セクションデータの一括取得
- **差分更新**: 変更分のみの送受信
- **圧縮**: レスポンスデータの適切な圧縮
- **CDN活用**: 静的リソースの配信最適化

キャッシュ戦略:
- **プリフェッチ**: 次に必要なデータの事前取得
- **バックグラウンド更新**: 表示中データの背景更新
- **オフライン対応**: Service Worker活用・データ永続化
```

---

## 8. エラーハンドリング・復旧

### エラー種別・対応
```
システムエラー:
- **API障害**: 自動リトライ・フォールバック表示
- **ネットワークエラー**: オフライン表示・キューイング
- **認証エラー**: 自動ログイン・セッション復旧

データエラー:
- **不整合データ**: データ修復・整合性チェック
- **欠損データ**: デフォルト値表示・手動補完
- **競合状態**: 楽観的排他制御・マージ処理

UI/UXエラー:
- **レンダリング失敗**: Error Boundary・復旧UI
- **操作競合**: 操作ロック・順次実行
- **状態不整合**: 状態リセット・初期化処理
```

### 復旧・フォールバック
```
自動復旧:
- **段階的リトライ**: 指数バックオフ・最大試行回数
- **部分機能維持**: エラー箇所の隔離・他機能継続
- **データ同期**: 復旧時の差分同期・整合性確保

手動復旧:
- **リフレッシュボタン**: ユーザー操作での強制更新
- **個別セクション**: セクション単位でのリロード
- **全体リセット**: 全状態クリア・初期状態復帰
```

---

## 📚 関連ドキュメント

### デザインシステム
- **[Section UI Specifications](./section-ui-specifications.md)** - セクション内UI共通ルール
- **[Common UI Specifications](./common-ui-specifications.md)** - サイト横断共通UI
- **[Brand Identity](./brand-identity.md)** - ブランド・色・フォント仕様

### テンプレート
- **[Service Template](../templates/wireframe/service.md)** - サービス個別統合仕様テンプレート
- **[Section Template](../templates/wireframe/section.md)** - セクション個別仕様テンプレート

### アーキテクチャ
- **[System Architecture](../architecture/system-architecture.md)** - システム全体設計
- **[API Specification](../architecture/api-specification.md)** - API仕様

---

> **💡 Key Principle**: 
> サービス統合UI仕様は「一貫性」と「効率性」を両立し、複数セクションの協調動作による最適なユーザー体験を目指します。

> **🎯 Implementation Goal**:
> 各サービスで統一された統合パターンを提供し、セクション間の自然な連携と直感的な操作環境を構築します。